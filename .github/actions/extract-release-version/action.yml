name: Find Current Version to Release
description: Reusable GitHub Action to find the currently scheduled Milestone according to the SNAPSHOT version from Gradle or Maven.
author: Spring

outputs:
  releaseVersion:
    description: Current Milestone to release
    value: ${{ steps.release-version.outputs.releaseVersion }}

runs:
  using: composite
  steps:
    - uses: actions/checkout@v4
      with:
        show-progress: false

    - uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - name: Find Current Version to Release
      id: release-version
      shell: bash
      run: |
        if test -f pom.xml
        then
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression="project.version" -q -DforceStdout)
        else
          CURRENT_VERSION=$(gradle properties --no-daemon --console=plain -q | grep "^version:" | awk '{printf $2}')
        fi
        export CANDIDATE_VERSION=${CURRENT_VERSION/-SNAPSHOT}
        RELEASE_VERSION=$(gh api repos/$GITHUB_REPOSITORY/milestones --jq 'map(select(.due_on != null and (.title | startswith(env.CANDIDATE_VERSION)))) | .[0] | .title')
        if [ -z $RELEASE_VERSION ]
        then
          gh run cancel ${{ github.run_id }}
          echo "::warning title=Nothing to release::No scheduled milestone for $CURRENT_VERSION version"
        else
          echo releaseVersion=$RELEASE_VERSION >> $GITHUB_OUTPUT
          echo "::notice title=RELEASE VERSION::$RELEASE_VERSION"
        fi